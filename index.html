<!DOCTYPE html>
<!--[if lt IE 7]> <html class="no-js lt-ie9 lt-ie8 lt-ie7" lang="en"> <![endif]-->
<!--[if IE 7]>    <html class="no-js lt-ie9 lt-ie8" lang="en"> <![endif]-->
<!--[if IE 8]>    <html class="no-js lt-ie9" lang="en"> <![endif]-->
<!--[if gt IE 8]><!-->
<html class="no-js" lang="en">
	<!--<![endif]-->
	<head>
		<meta charset="utf-8" />
		<!-- Fix static header bug in Android 2.2 -->
		<meta content='width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0' name='viewport' />
		<meta name="viewport" content="width=device-width" />
		<title>Nintendo Ninja | An FPGA-Based Mario Bros. A.I.</title>
		<link rel="shortcut icon" href="/favicon.ico" type="image/x-icon">
		<link rel="icon" href="/favicon.ico" type="image/x-icon">
		<link rel="stylesheet" href="stylesheets/foundation.min.css">
		<link rel="stylesheet" href="stylesheets/app.css?v=2">
        <link rel="stylesheet" href="stylesheets/prettyPhoto.css" type="text/css" media="screen" title="prettyPhoto main stylesheet" charset="utf-8" />
		<script src="javascripts/modernizr.foundation.js"></script>
		<!--[if lt IE 9]>
		<script src="http://html5shiv.googlecode.com/svn/trunk/html5.js"></script>
		<![endif]-->
	</head>
	<body>
		<div class="header-row">
			<div class="row">
				<div class="four columns">
					<a class="scroll hide-for-small" href="#intro"><img src="images/head.png"></a>
					<a id="nav-trigger" class="show-for-small" href="#"><img class="nav-menu-btn" src="images/icons/menu.png"><img src="images/head.png"></a>
				</div>
				<div class="eight columns hide-for-small desktop-nav">
					<ul data-magellan-expedition>
						<li style="display:none;" data-magellan-arrival='intro'></li>
						<a class="scroll" href="#overview">
						<li data-magellan-arrival='overview'>
							Overview
						</li></a>
						<a class="scroll" href="#design">
						<li data-magellan-arrival='design'>
							Design
						</li></a>
						<a class="scroll" href="#results">
						<li data-magellan-arrival='results'>
							Results
						</li></a>
						<a class="scroll" href="#conclusions">
						<li data-magellan-arrival='conclusions'>
							Conclusions
						</li></a>
						<a class="scroll" href="#appendix">
						<li data-magellan-arrival='appendix'>
							Appendix
						</li></a>
					</ul>
				</div>
				<div id="mobile-nav" class="show-for-small">
					<h3>Menu</h3><a id="nav-close-trigger" href="#"><img class="nav-menu-btn" src="images/icons/close.png"></a>
					<ul data-magellan-expedition>
						<a class="mobile" href="#intro">
						<li data-magellan-arrival='intro'>
							Intro
						</li></a>
						<a class="mobile" href="#overview">
						<li data-magellan-arrival='overview'>
							Overview
						</li></a>
						<a class="mobile" href="#design">
						<li data-magellan-arrival='design'>
							Design
						</li></a>
						<a class="mobile" href="#results">
						<li data-magellan-arrival='results'>
							Results
						</li></a>
						<a class="mobile" href="#conclusions">
						<li data-magellan-arrival='conclusions'>
							Conclusions
						</li></a>
						<a class="mobile" href="#appendix">
						<li data-magellan-arrival='appendix'>
							Appendix
						</li></a>
					</ul>
				</div>
			</div>
		</div>

		<div id="intro" class="row">
			<div class="twelve columns main-wrapper" style="position:relative;">

				<!-- Background -->
				<div class="row stripe-height-container">
					<div class="four columns stripe-width-container">
						<div class="stripe-container"></div>
					</div>
				</div>

				<!-- Intro Blurb -->
				<div class="row" data-magellan-destination='intro'>
					<div class="eight columns offset-by-four intro-blurb">
						<h1>A Hardware-Based FPGA AI for Super Mario Bros.</h1>
						<p>
						Nintendo Ninja is a final project for <a href="http://people.ece.cornell.edu/land/courses/ece5760/" title="ECE 5760 Website" target="_blank">ECE5760</a> (Advanced Microcontroller Design) at <a href="http://www.ece.cornell.edu/" title="Cornell ECE Website" target="_blank">Cornell University</a>.  The project was developed by <a href="http://www.jeremyblum.com" title="Jeremy's Website" target="_blank">Jeremy Blum</a>, <a href="http://www.simamitra.com" title="Sima's Website" target="_blank">Sima Mitra</a>, and <a href="http://www.jpwright.net" title="Jason's Website" target="_blank">Jason Wright</a> in the 2013 Spring Semester. This project is <a href="https://github.com/jpwright/fpganes" title="GitHub Repo" target="_blank">Open Source</a>.</p>
					</div>
				</div>

				<!-- Overview Section -->
				<div class="nav-spacer" id="overview" data-magellan-destination='overview'>
					<div class="row">
						<h1>Overview</h1>
						<hr />
						<div class="six columns">
							<img class="radius" src="images/visit.jpg">
						</div>
						<div class="six columns">
							<div class="visit-quote">
								<h3 class="special">Cramming a Cyclone II...</h3>
								<h3 class="right special" style="text-align:right;">...into Mario's Brain.</h3>
								<div class="clearfix"></div>
							</div>
							<p>
								Super Mario is possibly one of the world's best-known video games. It's been analyzed in detail, beaten millions of times, and it's super fun.  Nintendo Ninja is an FPGA-Based AI that uses video input from an NES console to automatically play the game. All of the video analysis and AI techniques are performed using Verilog-compiled hardware running on an Altera DE2 Cyclone board. The project combines NTSC decoding, VGA output, kernel pattern matching, real-time image manipulation, and NES controller emulation. Below, we explain the <a href="#design" class="scroll">system design</a>, <a href="#results" class="scroll">our results</a>, <a href="#conclusions" class="scroll">our conclusions</a>, and <a href="#appendix" class="scroll">useful appendices</a>.  The following video shows a demo of the system working.
							</p>
							<p class="video-btn">
                                <a href="http://www.youtube.com/watch?v=QH2-TGUlwu4" rel="prettyPhoto" title="This video shows the Nintendo Ninja in Action." class="button radius"><img style="height:10px;" src="images/icons/video.png" alt="Nintendo Ninja Video Demo">&nbsp;&nbsp;Watch the Video!</a>
								<!--<a href="#" class="button radius video-trigger"><img style="height:10px;" src="images/icons/video.png">&nbsp;&nbsp;Watch the Video!</a>-->
							</p>
						</div>
					</div>
				</div>

				<!-- Design Section -->
				<div class="nav-spacer" id="design" data-magellan-destination='design'>
					<div class="row">
						<h1>Design</h1>
                        <hr />
                        <h2>High Level Design</h2>
                        	<div class="indent">
                        	<h3>Rationale and Idea Origin</h3>
                            	<p>
                                	Developing an AI to play super mario offers a challenging problem that is not impossible to accomplish through mere observation of the video output. Trying to solve a more modern game (such as Super Mario 64) would essentially be impossible without directly reading the game's memory. We approached the idea believing that Super Mario Bros. is a fairly deterministic environment with side-scrolling that makes it straight-forward to do edge and obstacle detection. Interfacing with the NES is also fairly straighforward, as the controller is nothing more than some buttons in an a parallel-to-serial shift register integrated circuit. Importantly, we believed that the game would provide a challenging problem with fairly large array of possible solutions.
                                </p>
                            <h3>Logical Structure</h3>
                            	<p>
                                	At a high level, our AI works by reading the each video frame into a buffer and analyzing it against a set of precomputed kernels and colors to look for areas of interest. The program then uses a kernel and color matching algorithm with an error threshold to attempt to identify the location of enemies, walls, mario, and warp pipes, while keeping false positives to a minimum.  With this information, the program makes decisions about when to make Mario jump and run so that he avoids enemies and obstacles. We chose to define "success" as Mario making it through the first level, alive, as quickly as possible.  Mario makes no attempts to kill enemies, obtain coins, or get powerups, though he frequently does through dumb luck.
                            	</p>
                        	<h3>Tradeoffs</h3>
                            	<div class="indent">
                                <h4>NIOS II vs Hardware</h4>
                                    <p>
                                        We chose to implement this project using custom hardware rather than instantiating a NIOS II processor on the FPGA and then programming in C. While coding in C is simpler, the VGA controllers typically used with the NIOS are vastly different from the custom controller we used to display the NTSC signal from the NES. Using custom hardware also allows us to access the VGA buffer directly, allowing us to read and write to the screen at the same time. This allows for greater computation parallelization so that we can simultaneously detect multiple types of obstacles at once.     
                                    </p>
                                <h4>Screen Scolling Correction</h4>
                                <div class="photo"><img src="images/scrolling.gif" alt="Screen Scrolling"><p class="caption">Screen Scrolling</p></div>
                                    <p>
                                        We attempted to correct the scrolling both in hardware, by using off-the-shelf NTSC to VGA converters and in software, by altering the VGA controller in the Verilog.  While the external hardware converters showed promise, they could not synchronize the Chroma and Luma values and could only consistently produce a grayscale image, sacrificing all of the color information needed for accurate obstacle detection. The after devoting over two weeks of the project to attempting to correct the vertical screen scrolling in software, we decided that we would need to implement an AI capable of playing the game even when the screen was constantly scrolling upward. 
                                    </p>
                                    <div class="clearfix"></div>
                        		</div>
                            <h3>Relevent Standards</h3>
                            	<div class="indent">
                                <h4>NTSC and VGA</h4>
                                    <p>
                                        The NES produces a non-standard NTSC signal which we convert to VGA. Unfortunately, the VGA controller on the DE2 board is only designed to handle well-formed NTSC signals and cannot properly read the vertical synch pulse. In order to have any visible image on the screen, the vertical synchronization was disabled. This results in the vertical scrolling of the VGA display. he NES produces a non-standard NTSC signal which we convert to VGA. Unfortunately, the VGA controller on the DE2 board is only designed to handle well-formed NTSC signals and cannot properly read the vertical synch pulse. This results in the vertical scrolling of the VGA display.  
                                    </p>
                        		</div>
                        	</div>
                            
                        <h2>Program/Hardware Design</h2>
                        	<div class="indent">
                            <h3>External Hardware</h3>
                            	<p>
                                	In order to interface with the NES, it is necessary for the Altera DE2 to emulate an NES Controller.  We also found that it was helpful to augment the board with a remote LED display that we could mount next to the monitor.  The LEDs light up various colors to indicate when a pipe,goomba, or brick is causing the Mario AI to jump.  The following schematic shows both of these pieces of additional hardware, and is references in the next two sub-sections:</p>
                                <div class="center"><a href="schematic/NintendoNinjaSchematic.png" rel="prettyPhoto"><img src="schematic/NintendoNinjaSchematicThumb.png" alt="System Hardware Schematic"></a></div>
                                <p class="caption">Schematic of Hardware Components (Click to Enlarge)</p>
                            	<div class="indent">
                            	<h4>GPIO to NES controller</h4>
                                	<div class="photo"><a href="images/controller.jpg" rel="prettyPhoto"><img src="images/controller_thumb.jpg" alt="NES Controller Board"></a><p class="caption">Controller Board (Click to Enlarge)</p></div>
                                	<p>The NES uses a very simple controller configuration: 8 buttons on the controller connect to a parallel-to-serial shift register, which clocks data into the NES based on a clock signal that is generated by the NES. The original NES used 4021 Shift Registers [<a href="#ref5" class="scroll">3</a>], which are now a bit harder to come by [<a href="#ref3" class="scroll">3</a>].  Instead, we used a 74165N Shift Register, which is nearly identical, except that the polarity of the latch input is inverted [<a href="#ref6" class="scroll">6</a>]. This was easily accomodated for with the addition of a not gate on the latch line from the NES. GPIO pins from the Altera DE2 board emulate "Active Low" button press signals which are sent to the parallel inputs of the shift register. Based on the CLK and LATCH signals from the NES, these button values are periodically shifted into the NES via the controller port.  The 5V power from the controller port is used to power the <em>shift</em> and <em>not</em> logic gates.  3.3V logic-level signals are sent from teh FPGA, but these exceed the threshold for logic high detection on both ICs.</p>
                                <div class="clearfix"></div>
                                <h4>Debugging LED Display</h4>
                                	<div class="photo"><a href="images/LEDs.jpg" rel="prettyPhoto"><img src="images/LEDs_thumb.jpg" alt="LED Jump Indicator"></a><p class="caption">LED Jump Indicator (Click to Enlarge)</p></div>
                                	<p>A second circuit board, mounted next to the display monitor, assists in the debugging of code by using color-coded LEDs to indicate what scene triggers are causing the Mario AI to execute a "jump" command.  The yellow LED lights up when Mario is jumping to avoid a pit or a wall.  The red LED lights up when Mario is jumping to avoid an enemy.  The green LED lights up to indicate that Mario is jumping to clear a pipe.</p>
                                </div>
                        	<div class="clearfix"></div>
                        	<h3>Verilog Breakdown</h3>
                            	<div class="indent">
                       			<h4>NTSC Decoding</h4>
                                <h4>VGA Output</h4>
                                <h4>Kernel Matching</h4>
                                <h4>Thresholding</h4>
                                <h4>Screen Updates</h4>
                                <h4>NES Control Ouput</h4>
                                </div>
                            </div>
                
                    
					</div>
				</div>

				<!-- results Section -->
				<div class="nav-spacer" id="results" data-magellan-destination='results'>
					<div class="row">
						<h1>Results</h1>
						<hr />
						<div class="six columns">
                        	<h2>Execution</h2>
                        		<p>We were able to implement a simple AI to play World 1-1 of Super Mario Bros. for the NES. The AI is able to play in real time by plugging in a custom controller-to-GPIO breakout into one of the controller ports of the NES. The AI can successfully complete the level approximately QQ% of the time.</p>
								<p>Since the NES does not have a standard NTSC signal, the VGA controller produces a constantly scrolling image. The FPGA is still able to play the game by only looking at the horizontal position of the obstacles and enemies detected and by calculating some of the vertical information by searching for the location of the empty black bar of space that appears between frames.  This also means that the FPGA only knows the image information that it is capable of displaying. When enemies or obstacles are not being displayed on the VGA, there are not visible to the AI, making the game challenging to play.</p>
								<p>The general strategy of the AI is to jump over pipes, stomp on goombas, and jump over gaps in the ground.  The FPGA concurrently searches for the goombas, pipes and gaps by comparing a kernel of a unique area on these sprites to an 11x640 buffer that is constantly being updated as a new pixel is written to the VGA display. When the number of matching pixels exceeds a certain threshold and it is in the portion of the screen to the right of center, that obstacle is determined to be present. Once a frame, all of these signals are polled and Mario will jump to avoid the obstacle, remaining in the air for a length of time related to which obstacle was sensed. Some obstacles have priority over others to avoid conflicts that could cause Mario to jump into an enemy or trap.</p>
								<p>Where the hardware detects matches between the obstacle kernels and the screen, the matching pixels are displayed on the screen: green pixels appear where pipes are sensed, yellow for the edges of bricks and red for the Goomba and Koopa enemies. Due to the 4 frame delay introduced to give the FPGA enough time to compute these matches, these appear as streaks on the screen. This coloring can be toggled off using the switches on the FPGA. Since there is no vertical synchronization and we are writing to the screen multiple times per frame, this will occasionally cause the NTSC decoder to lose Chroma/Luma synchronization, causing the colors on the screen to invert. This can be corrected by manually resetting the decoder by pressing KEY[0] or toggling SW[].</p>

							<h2>Accuracy</h2>
								<p>With this system, it is also possible to use the AI as a second player in the 2 player version of the game, but the AI has only been trained on the enemies and obstacles of World 1-1.</p>

							<h2>Usability</h2>
								<p>
								This is neat.
								</p>
						</div>
						<div class="six columns">
							<ul class="block-grid three-up">
								<li>
                                	<a href="images/space/6.jpg" rel="prettyPhoto[space]" title="An Image Caption!"><img src="images/space/thumbs/6.jpg" alt="Alt Description" /></a>
								</li>
								<li>
									<a href="images/space/2.jpg" rel="prettyPhoto[space]" title="An Image Caption!"><img src="images/space/thumbs/2.jpg" alt="Alt Description"></a>
								</li>
								<li>
									<a href="images/space/1.jpg" rel="prettyPhoto[space]" title="An Image Caption!"><img src="images/space/thumbs/1.jpg" alt="Alt Description"></a>
								</li>
								<li>
									<a href="images/space/5.jpg" rel="prettyPhoto[space]" title="An Image Caption!"><img src="images/space/thumbs/5.jpg" alt="Alt Description"></a>
								</li>
								<li>
									<a href="images/space/3.jpg" rel="prettyPhoto[space]" title="An Image Caption!"><img src="images/space/thumbs/3.jpg" alt="Alt Description"></a>
								</li>
								<li>
									<a href="images/space/4.jpg" rel="prettyPhoto[space]" title="An Image Caption!"><img src="images/space/thumbs/4.jpg" alt="Alt Description"></a>
								</li>
								<li>
									<a href="images/space/7.jpg" rel="prettyPhoto[space]" title="An Image Caption!"><img src="images/space/thumbs/7.jpg" alt="Alt Description"></a>
								</li>
								<li>
									<a href="images/space/8.jpg" rel="prettyPhoto[space]" title="An Image Caption!"><img src="images/space/thumbs/8.jpg" alt="Alt Description"></a>
								</li>
								<li>
									<a href="images/space/9.jpg" rel="prettyPhoto[space]" title="An Image Caption!"><img src="images/space/thumbs/9.jpg" alt="Alt Description"></a>
								</li>
							</ul>
						</div>
					</div>
				</div>

				<!-- Conclusions Section -->
				<div class="nav-spacer" id="conclusions" data-magellan-destination='conclusions'>
					<div class="row">
						<div class="twelve columns">
							<h1>Conclusions</h1>
							<hr />
							<h3>Analysis</h3>
                            <p>stuff.</p>
							<h3>Intellectual Property Considerations</h3>
                            <p>more stuff.</p>
						</div>
					</div>
				</div>

				<!-- Appendix Section -->
				<div class="nav-spacer" id="appendix" data-magellan-destination='appendix'>
					<div class="row">
						<h1>Appendices and References</h1>
						<hr />
                            <h2>Appendix A: Commented Code</h2>
                            <p> </p>
                            <h2>Appendix B: Schematics</h2>
                            <p> </p>
                            <h2>Appendix C: Task Breakdown</h2>
                            <p> </p>
                            <h2>Refrences</h2>
                                <ol>
                                    <li id="ref1">
                                        <a href="datasheets/182877477ADV7181B_a.pdf">Datasheet for NTSC decorder used on the DE2 board</a>
                                    </li>
                                    <li id="ref2">
                                        <a href="http://people.ece.cornell.edu/land/courses/ece5760/StudentWork/video_to_VGA/cam_to_vga.zip">NTSC input-to-VGA display baseline Project</a>
                                    </li>
                                    <li id="ref3">
                                    	<a href="http://seb.riot.org/nescontr/">NES Controller Schematic</a>
                                    </li>
                                    <li id="ref4">
                                    	<a href="http://people.ece.cornell.edu/land/courses/ece5760/FinalProjects/f2010/kaf42_jay29_teg25/teg25_jay29_kaf42/index.html">Cartoonifier 5760 Project</a>
                                    </li>
                                    <li id="ref5">
                                    	<a href="datasheets/cd4021b.pdf">Datasheet for 4021 Shift Register</a>
                                    </li>
                                    <li id="ref6">
                                    	<a href="datasheets/74165-16p.pdf">Datasheet for 74165 Shift Register</a>
                                    </li>
                                </ol>
					</div>
				</div>

				<!-- Footer -->
				<div class="row footer">

					<!-- Stripe Ends (desktop view) -->
					<div class="four columns site-info hide-for-small">
						<img src="images/foot.png">
						<p>
							This site is <a href="https://github.com/sciguy14/NintendoNinja-Website">Open Source</a> and is forked from the <a href="http://popright.in">PopShop Website</a> by <a href="http://elmorris.me">Eric Morris</a>.
						</p>
						<p>
							The Nintendo Ninja Project is also <a href="https://github.com/jpwright/fpganes">Open Source</a>.
						</p>
					</div>
					<div class="two columns">
						<h5>Team</h5>
						<ul>
							<li>
								<a href="http://www.jeremyblum.com">Jeremy Blum</a>
							</li>
							<li>
								<a href="http://www.simamitra.com">Sima Mitra</a>
							</li>
							<li>
								<a href="http://www.jpwright.net">Jason Wright</a>
							</li>
						</ul>
					</div>
					<div class="three columns">
						<h5>Links</h5>
						<ul>
							<li>
								<a href="http://people.ece.cornell.edu/land/courses/ece5760/">ECE5760 Course Website</a>
							</li>
							<li>
								<a href="http://www.altera.com/education/univ/materials/boards/de2/unv-de2-board.html">Altera DE2 Homepage</a>
							</li>
							<li>
								<a href="https://instruct1.cit.cornell.edu/courses/ece576/FinalProjects/f2010/kaf42_jay29_teg25/teg25_jay29_kaf42/index.html">Cartoonifier Project</a>
							</li>
						</ul>
					</div>
					<div class="three columns hide-for-small">
						<a href="http://www.ece.cornell.edu/" alt="Cornell University, School of Electrical and Computer Engineering" title="Cornell University, School of Electrical and Computer Engineering"><img src="images/cu_logo.png"></a>
					</div>

					<!-- Stripe Ends (single column view) -->
					<div class="four columns site-info show-for-small">
						<img src="images/foot.png">
						<p>
							This site is <a href="https://github.com/sciguy14/NintendoNinja-Website">Open Source</a> and is forked from the <a href="http://popright.in">PopShop Website</a> by <a href="http://elmorris.me">Eric Morris</a>.
						</p>
						<p>
							The Nintendo Ninja Project is also <a href="https://github.com/jpwright/fpganes">Open Source</a>.
						</p>
						<p>
							Project by <a href="http://jeremyblum.com">Jeremy Blum</a>, <a href="http://simamitra.com">Sima Mitra</a>, and <a href="http://jpwright.net">Jason Wright</a>.
						</p>
					</div>
				</div>
			</div>
		</div>




		<!-- Uncompressed Javascripts -->
        
		<script src="javascripts/foundation.min.js"></script>
        <script src="javascripts/jquery.prettyPhoto.js" type="text/javascript" charset="utf-8"></script>
		<script src="javascripts/app.js"></script>
        
        <script type="text/javascript" charset="utf-8">
			$(document).ready(function(){
				$("a[rel^='prettyPhoto']").prettyPhoto();
		  	});
		  
			$(document).ready(function(){
				$("a[rel^='prettyPhoto']").prettyPhoto({
					social_tools: false,
					deeplinking: false,
					default_width: 800,
					default_height: 600
				});
			});
		</script>
		<!-- JSON-P -->
		
	</body>
